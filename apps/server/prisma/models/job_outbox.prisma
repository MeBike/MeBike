enum JobOutboxStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

model JobOutbox {
  id        String          @id @default(uuid(7)) @db.Uuid
  type      String
  dedupeKey String?         @map("dedupe_key")
  payload   Json            @db.JsonB
  runAt     DateTime        @map("run_at") @db.Timestamptz
  status    JobOutboxStatus @default(PENDING)
  attempts  Int             @default(0)
  lockedAt  DateTime?       @map("locked_at") @db.Timestamptz
  lockedBy  String?         @map("locked_by")
  lastError String?         @map("last_error")
  sentAt    DateTime?       @map("sent_at") @db.Timestamptz
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime        @default(now()) @map("updated_at") @db.Timestamptz

  @@index([status, runAt], name: "idx_job_outbox_status_run_at")
  @@index([type, status], name: "idx_job_outbox_type_status")
  // Partial unique index for dedupe is applied via migration:
  // CREATE UNIQUE INDEX job_outbox_type_dedupe_active
  //   ON job_outbox(type, dedupe_key)
  //   WHERE dedupe_key IS NOT NULL AND status IN ('PENDING','SENT');
  @@map("job_outbox")
}
