// Enums specific to reservations
enum ReservationStatus {
  PENDING
  ACTIVE
  CANCELLED
  EXPIRED
}

enum ReservationOption {
  ONE_TIME
  FIXED_SLOT
  SUBSCRIPTION
}

// Reservations

model Reservation {
  id                  String            @id @default(uuid(7)) @db.Uuid
  userId              String            @map("user_id") @db.Uuid
  bikeId              String?           @map("bike_id") @db.Uuid
  stationId           String            @map("station_id") @db.Uuid
  reservationOption   ReservationOption @map("reservation_option")
  fixedSlotTemplateId String?           @map("fixed_slot_template_id") @db.Uuid
  subscriptionId      String?           @map("subscription_id") @db.Uuid
  startTime           DateTime          @map("start_time") @db.Timestamptz
  endTime             DateTime?         @map("end_time") @db.Timestamptz
  prepaid             Decimal           @default(0) @db.Decimal(12, 2)
  status              ReservationStatus @default(PENDING)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime          @default(now()) @map("updated_at") @db.Timestamptz

  user              User               @relation(fields: [userId], references: [id])
  bike              Bike?              @relation(fields: [bikeId], references: [id])
  station           Station            @relation(fields: [stationId], references: [id])
  fixedSlotTemplate FixedSlotTemplate? @relation(fields: [fixedSlotTemplateId], references: [id])
  subscription      Subscription?      @relation(fields: [subscriptionId], references: [id])
  // Partial unique index (active reservations per bike) cannot be expressed in Prisma; add manually:
  // CREATE UNIQUE INDEX idx_reservations_active_bike ON reservations(bike_id) WHERE status IN ('PENDING','ACTIVE') AND bike_id IS NOT NULL;
  // Partial unique index (active reservations per user) cannot be expressed in Prisma; add manually:
  // CREATE UNIQUE INDEX idx_reservations_active_user ON reservations(user_id) WHERE status IN ('PENDING','ACTIVE');
  // TODO(fixed-slot): If FIXED_SLOT should coexist with normal holds, scope the user constraint to bike-holds only:
  // CREATE UNIQUE INDEX idx_reservations_active_user ON reservations(user_id) WHERE status IN ('PENDING','ACTIVE') AND bike_id IS NOT NULL;
  // Fixed-slot idempotency (one reservation per template per slot timestamp) cannot be expressed in Prisma; add manually:
  // CREATE UNIQUE INDEX uq_reservations_fixed_slot_template_start_time ON reservations(fixed_slot_template_id, start_time) WHERE fixed_slot_template_id IS NOT NULL;

  @@index([userId], name: "idx_reservations_user")
  @@index([bikeId], name: "idx_reservations_bike")
  @@index([stationId], name: "idx_reservations_station")
  @@index([status], name: "idx_reservations_status")
}
